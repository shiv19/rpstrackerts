<Page
    class="page"
    navigatingTo="onNavigatingTo"
    xmlns:df="nativescript-pro-ui/dataform"
    xmlns="http://schemas.nativescript.org/tns.xsd">
    <ActionBar title="Item">
        <NavigationButton text="Back" android.systemIcon="ic_menu_back" tap="onNavBackTap"></NavigationButton>

        <ActionItem tap="onDeleteTap" ios.systemIcon="16" ios.position="right" text="delete" android.systemIcon="ic_menu_delete"
            android.position="actionBar"></ActionItem>
    </ActionBar>

    <StackLayout>

        <GridLayout class="pt-item-detail-header" rows="*, 40">

            <GridLayout row="0" columns="auto, *" class="pt-item-detail-header-title-row">
                <Image id="assigneeImg" width="50" height="50" class="pt-item-detail-avatar" src="{{ item.assignee.avatar }}" col="0" />
                <Label text="{{ item.title }}" class="pt-item-detail-header-title" col="1"></Label>
            </GridLayout>

            <StackLayout row="1">
                <FlexboxLayout class="selector">
                    <GridLayout class="{{ selectedScreen === 'details' ? 'selector-btn-wrapper active' : 'selector-btn-wrapper' }}">
                        <Button tap="onDetailsTap" text="Details" 
                            class="{{ selectedScreen === 'details' ? 'selector-btn active' : 'selector-btn' }}"></Button>
                    </GridLayout>
                    <GridLayout class="{{ selectedScreen === 'tasks' ? 'selector-btn-wrapper active' : 'selector-btn-wrapper' }}">
                        <Button tap="onTasksTap" text="Tasks" 
                            class="{{ selectedScreen === 'tasks' ? 'selector-btn active' : 'selector-btn' }}"></Button>
                    </GridLayout>
                    <GridLayout class="{{ selectedScreen === 'chitchat' ? 'selector-btn-wrapper active' : 'selector-btn-wrapper' }}">
                        <Button tap="onChitchatTap" text="Chitchat" 
                            class="{{ selectedScreen === 'chitchat' ? 'selector-btn active' : 'selector-btn' }}"></Button>
                    </GridLayout>
                </FlexboxLayout>
            </StackLayout>
        </GridLayout>

        <StackLayout>
            <!-- Details -->
            <GridLayout visibility="{{ selectedScreen === 'details' ? 'visible' : 'collapsed' }}"
                rows="auto, auto" class="pt-item-details-container">

                <df:RadDataForm row="0" source="{{ form }}" metadata="{{ formMetaData }}" propertyCommitted="{{ onPropertyCommitted }}" />
                <StackLayout row="1">
                    <Label text="Assignee" fontSize="12" paddingLeft="18" color="#808080" />
                    <Button id="assigneeBtn" class="btn btn-primary" backgroundColor="lightgray"
                        text="{{ item.assignee.fullName }}" tap="{{ onAssigneeSelect }}" />
                </StackLayout>

            </GridLayout>

            <!-- Tasks -->
            <GridLayout visibility="{{ selectedScreen === 'tasks' ? 'visible' : 'collapsed' }}"
                rows="70, *" class="pt-item-tasks-container">
                <GridLayout row="0" columns="*, 80" class="pt-tasks-add-row">
                    <TextField hint="Enter new task..." text="{{ newTaskTitle }}" col="0" class="pt-text-task-add" />
                    <Button tap="onAddTask" text="Add" col="1"
                        class="{{ newTaskTitle.length > 0 ? 'pt-btn-task-add enabled' : 'pt-btn-task-add' }}"
                        isEnabled="{{ newTaskTitle.length > 0 }}"></Button>
                </GridLayout>

                <ScrollView row="1" class="pt-tasks-scroll">
                    <StackLayout class="pt-tasks-list-container">
                        <Repeater id="tasksList" items="{{ item.tasks }}">
                            <Repeater.itemTemplate>
                                <GridLayout columns="30, *" class="pt-task-wrapper">
                                    <Image tap="toggleTapped" src="{{ completed ? 'res://checkboxchecked' : 'res://checkboxunchecked' }}" class="task-checkbox"
                                        col="0" />
                                    <TextField col="1" text="{{ title }}"
                                        class="task-title" />
                                </GridLayout>
                            </Repeater.itemTemplate>
                        </Repeater>
                    </StackLayout>
                </ScrollView>
            </GridLayout>

            <!-- Chitchat -->
            <GridLayout visibility="{{ selectedScreen === 'chitchat' ? 'visible' : 'collapsed' }}"
                rows="70, *" class="pt-item-chitchat-container">

                <GridLayout row="0" columns="60, *, 80" class="pt-comments-add-row">
                    <!-- TODO: put current user avatar here -->
                    <Image src="{{ item.assignee.avatar }}" stretch="aspectFit" class="pt-img-comment-add" col="0" />
                    <TextField text="" hint="Enter new comment..." col="1" class="pt-text-comment-add" />
                    <Button tap="onAddTapped" text="Add" col="2" class="pt-btn-comment-add" />
                </GridLayout>

                <ScrollView row="1" class="pt-comments-scroll">
                    <StackLayout class="pt-comments-list-container">
                        <Repeater items="{{ item.comments }}">
                            <Repeater.itemTemplate>
                                <GridLayout columns="40, *" class="pt-comment-wrapper">
                                    <Image src="{{ user.avatar }}" width="40" height="40" stretch="aspectFit" class="img-comment-avatar" col="0" />

                                    <GridLayout col="1" rows="20, *" columns="*, 150" class="comment-text-wrapper">
                                        <Label col="0" row="0" text="{{ user.fullName }}" class="comment-name"></Label>
                                        <Label col="1" row="0" text="{{ dateCreated | dateConvertor }}" class="comment-date"></Label>

                                        <TextView colSpan="2" row="1" text="{{ title }}" editable="false" class="comment-text"></TextView>
                                    </GridLayout>
                                </GridLayout>
                            </Repeater.itemTemplate>
                        </Repeater>
                    </StackLayout>
                </ScrollView>

            </GridLayout>

        </StackLayout>

    </StackLayout>
</Page>